{"ast":null,"code":"/*! @azure/msal-common v4.3.0 2021-05-12 */\n'use strict';\n\nimport { __extends, __awaiter, __generator } from '../_virtual/_tslib.js';\nimport { BaseClient } from './BaseClient.js';\nimport { ClientAuthError } from '../error/ClientAuthError.js';\nimport { RequestParameterBuilder } from '../request/RequestParameterBuilder.js';\nimport { GrantType, Constants } from '../utils/Constants.js';\nimport { TimeUtils } from '../utils/TimeUtils.js';\nimport { ResponseHandler } from '../response/ResponseHandler.js';\nimport { StringUtils } from '../utils/StringUtils.js';\n/*\r\n * Copyright (c) Microsoft Corporation. All rights reserved.\r\n * Licensed under the MIT License.\r\n */\n\n/**\r\n * OAuth2.0 Device code client\r\n */\n\nvar DeviceCodeClient =\n/** @class */\nfunction (_super) {\n  __extends(DeviceCodeClient, _super);\n\n  function DeviceCodeClient(configuration) {\n    return _super.call(this, configuration) || this;\n  }\n  /**\r\n   * Gets device code from device code endpoint, calls back to with device code response, and\r\n   * polls token endpoint to exchange device code for tokens\r\n   * @param request\r\n   */\n\n\n  DeviceCodeClient.prototype.acquireToken = function (request) {\n    return __awaiter(this, void 0, void 0, function () {\n      var deviceCodeResponse, reqTimestamp, response, responseHandler;\n      return __generator(this, function (_a) {\n        switch (_a.label) {\n          case 0:\n            return [4\n            /*yield*/\n            , this.getDeviceCode(request)];\n\n          case 1:\n            deviceCodeResponse = _a.sent();\n            request.deviceCodeCallback(deviceCodeResponse);\n            reqTimestamp = TimeUtils.nowSeconds();\n            return [4\n            /*yield*/\n            , this.acquireTokenWithDeviceCode(request, deviceCodeResponse)];\n\n          case 2:\n            response = _a.sent();\n            responseHandler = new ResponseHandler(this.config.authOptions.clientId, this.cacheManager, this.cryptoUtils, this.logger, this.config.serializableCache, this.config.persistencePlugin); // Validate response. This function throws a server error if an error is returned by the server.\n\n            responseHandler.validateTokenResponse(response);\n            return [4\n            /*yield*/\n            , responseHandler.handleServerTokenResponse(response, this.authority, reqTimestamp, request)];\n\n          case 3:\n            return [2\n            /*return*/\n            , _a.sent()];\n        }\n      });\n    });\n  };\n  /**\r\n   * Creates device code request and executes http GET\r\n   * @param request\r\n   */\n\n\n  DeviceCodeClient.prototype.getDeviceCode = function (request) {\n    return __awaiter(this, void 0, void 0, function () {\n      var queryString, headers, thumbprint;\n      return __generator(this, function (_a) {\n        queryString = this.createQueryString(request);\n        headers = this.createDefaultTokenRequestHeaders();\n        thumbprint = {\n          clientId: this.config.authOptions.clientId,\n          authority: request.authority,\n          scopes: request.scopes\n        };\n        return [2\n        /*return*/\n        , this.executePostRequestToDeviceCodeEndpoint(this.authority.deviceCodeEndpoint, queryString, headers, thumbprint)];\n      });\n    });\n  };\n  /**\r\n   * Executes POST request to device code endpoint\r\n   * @param deviceCodeEndpoint\r\n   * @param queryString\r\n   * @param headers\r\n   */\n\n\n  DeviceCodeClient.prototype.executePostRequestToDeviceCodeEndpoint = function (deviceCodeEndpoint, queryString, headers, thumbprint) {\n    return __awaiter(this, void 0, void 0, function () {\n      var _a, userCode, deviceCode, verificationUri, expiresIn, interval, message;\n\n      return __generator(this, function (_b) {\n        switch (_b.label) {\n          case 0:\n            return [4\n            /*yield*/\n            , this.networkManager.sendPostRequest(thumbprint, deviceCodeEndpoint, {\n              body: queryString,\n              headers: headers\n            })];\n\n          case 1:\n            _a = _b.sent().body, userCode = _a.user_code, deviceCode = _a.device_code, verificationUri = _a.verification_uri, expiresIn = _a.expires_in, interval = _a.interval, message = _a.message;\n            return [2\n            /*return*/\n            , {\n              userCode: userCode,\n              deviceCode: deviceCode,\n              verificationUri: verificationUri,\n              expiresIn: expiresIn,\n              interval: interval,\n              message: message\n            }];\n        }\n      });\n    });\n  };\n  /**\r\n   * Create device code endpoint query parameters and returns string\r\n   */\n\n\n  DeviceCodeClient.prototype.createQueryString = function (request) {\n    var parameterBuilder = new RequestParameterBuilder();\n    parameterBuilder.addScopes(request.scopes);\n    parameterBuilder.addClientId(this.config.authOptions.clientId);\n\n    if (!StringUtils.isEmpty(request.claims) || this.config.authOptions.clientCapabilities && this.config.authOptions.clientCapabilities.length > 0) {\n      parameterBuilder.addClaims(request.claims, this.config.authOptions.clientCapabilities);\n    }\n\n    return parameterBuilder.createQueryString();\n  };\n  /**\r\n   * Creates token request with device code response and polls token endpoint at interval set by the device code\r\n   * response\r\n   * @param request\r\n   * @param deviceCodeResponse\r\n   */\n\n\n  DeviceCodeClient.prototype.acquireTokenWithDeviceCode = function (request, deviceCodeResponse) {\n    return __awaiter(this, void 0, void 0, function () {\n      var requestBody, headers, userSpecifiedTimeout, deviceCodeExpirationTime, pollingIntervalMilli;\n\n      var _this = this;\n\n      return __generator(this, function (_a) {\n        requestBody = this.createTokenRequestBody(request, deviceCodeResponse);\n        headers = this.createDefaultTokenRequestHeaders();\n        userSpecifiedTimeout = request.timeout ? TimeUtils.nowSeconds() + request.timeout : undefined;\n        deviceCodeExpirationTime = TimeUtils.nowSeconds() + deviceCodeResponse.expiresIn;\n        pollingIntervalMilli = deviceCodeResponse.interval * 1000;\n        /*\r\n         * Poll token endpoint while (device code is not expired AND operation has not been cancelled by\r\n         * setting CancellationToken.cancel = true). POST request is sent at interval set by pollingIntervalMilli\r\n         */\n\n        return [2\n        /*return*/\n        , new Promise(function (resolve, reject) {\n          var intervalId = setInterval(function () {\n            return __awaiter(_this, void 0, void 0, function () {\n              var thumbprint, response, error_1;\n              return __generator(this, function (_a) {\n                switch (_a.label) {\n                  case 0:\n                    _a.trys.push([0, 6,, 7]);\n\n                    if (!request.cancel) return [3\n                    /*break*/\n                    , 1];\n                    this.logger.error(\"Token request cancelled by setting DeviceCodeRequest.cancel = true\");\n                    clearInterval(intervalId);\n                    reject(ClientAuthError.createDeviceCodeCancelledError());\n                    return [3\n                    /*break*/\n                    , 5];\n\n                  case 1:\n                    if (!(userSpecifiedTimeout && userSpecifiedTimeout < deviceCodeExpirationTime && TimeUtils.nowSeconds() > userSpecifiedTimeout)) return [3\n                    /*break*/\n                    , 2];\n                    this.logger.error(\"User defined timeout for device code polling reached. The timeout was set for \" + userSpecifiedTimeout);\n                    clearInterval(intervalId);\n                    reject(ClientAuthError.createUserTimeoutReachedError());\n                    return [3\n                    /*break*/\n                    , 5];\n\n                  case 2:\n                    if (!(TimeUtils.nowSeconds() > deviceCodeExpirationTime)) return [3\n                    /*break*/\n                    , 3];\n\n                    if (userSpecifiedTimeout) {\n                      this.logger.verbose(\"User specified timeout ignored as the device code has expired before the timeout elapsed. The user specified timeout was set for \" + userSpecifiedTimeout);\n                    }\n\n                    this.logger.error(\"Device code expired. Expiration time of device code was \" + deviceCodeExpirationTime);\n                    clearInterval(intervalId);\n                    reject(ClientAuthError.createDeviceCodeExpiredError());\n                    return [3\n                    /*break*/\n                    , 5];\n\n                  case 3:\n                    thumbprint = {\n                      clientId: this.config.authOptions.clientId,\n                      authority: request.authority,\n                      scopes: request.scopes\n                    };\n                    return [4\n                    /*yield*/\n                    , this.executePostToTokenEndpoint(this.authority.tokenEndpoint, requestBody, headers, thumbprint)];\n\n                  case 4:\n                    response = _a.sent();\n\n                    if (response.body && response.body.error === Constants.AUTHORIZATION_PENDING) {\n                      // user authorization is pending. Sleep for polling interval and try again\n                      this.logger.info(response.body.error_description || \"no_error_description\");\n                    } else {\n                      clearInterval(intervalId);\n                      resolve(response.body);\n                    }\n\n                    _a.label = 5;\n\n                  case 5:\n                    return [3\n                    /*break*/\n                    , 7];\n\n                  case 6:\n                    error_1 = _a.sent();\n                    clearInterval(intervalId);\n                    reject(error_1);\n                    return [3\n                    /*break*/\n                    , 7];\n\n                  case 7:\n                    return [2\n                    /*return*/\n                    ];\n                }\n              });\n            });\n          }, pollingIntervalMilli);\n        })];\n      });\n    });\n  };\n  /**\r\n   * Creates query parameters and converts to string.\r\n   * @param request\r\n   * @param deviceCodeResponse\r\n   */\n\n\n  DeviceCodeClient.prototype.createTokenRequestBody = function (request, deviceCodeResponse) {\n    var requestParameters = new RequestParameterBuilder();\n    requestParameters.addScopes(request.scopes);\n    requestParameters.addClientId(this.config.authOptions.clientId);\n    requestParameters.addGrantType(GrantType.DEVICE_CODE_GRANT);\n    requestParameters.addDeviceCode(deviceCodeResponse.deviceCode);\n    var correlationId = request.correlationId || this.config.cryptoInterface.createNewGuid();\n    requestParameters.addCorrelationId(correlationId);\n    requestParameters.addClientInfo();\n    requestParameters.addLibraryInfo(this.config.libraryInfo);\n    requestParameters.addThrottling();\n\n    if (this.serverTelemetryManager) {\n      requestParameters.addServerTelemetry(this.serverTelemetryManager);\n    }\n\n    if (!StringUtils.isEmptyObj(request.claims) || this.config.authOptions.clientCapabilities && this.config.authOptions.clientCapabilities.length > 0) {\n      requestParameters.addClaims(request.claims, this.config.authOptions.clientCapabilities);\n    }\n\n    return requestParameters.createQueryString();\n  };\n\n  return DeviceCodeClient;\n}(BaseClient);\n\nexport { DeviceCodeClient };","map":{"version":3,"sources":["../../src/client/DeviceCodeClient.ts"],"names":[],"mappings":"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","sourcesContent":["/*\r\n * Copyright (c) Microsoft Corporation. All rights reserved.\r\n * Licensed under the MIT License.\r\n */\r\n\r\nimport { DeviceCodeResponse, ServerDeviceCodeResponse } from \"../response/DeviceCodeResponse\";\r\nimport { BaseClient } from \"./BaseClient\";\r\nimport { CommonDeviceCodeRequest } from \"../request/CommonDeviceCodeRequest\";\r\nimport { ClientAuthError } from \"../error/ClientAuthError\";\r\nimport { RequestParameterBuilder } from \"../request/RequestParameterBuilder\";\r\nimport { Constants, GrantType } from \"../utils/Constants\";\r\nimport { ClientConfiguration } from \"../config/ClientConfiguration\";\r\nimport { TimeUtils } from \"../utils/TimeUtils\";\r\nimport { ServerAuthorizationTokenResponse } from \"../response/ServerAuthorizationTokenResponse\";\r\nimport { ResponseHandler } from \"../response/ResponseHandler\";\r\nimport { AuthenticationResult } from \"../response/AuthenticationResult\";\r\nimport { StringUtils } from \"../utils/StringUtils\";\r\nimport { RequestThumbprint } from \"../network/RequestThumbprint\";\r\n\r\n/**\r\n * OAuth2.0 Device code client\r\n */\r\nexport class DeviceCodeClient extends BaseClient {\r\n\r\n    constructor(configuration: ClientConfiguration) {\r\n        super(configuration);\r\n    }\r\n\r\n    /**\r\n     * Gets device code from device code endpoint, calls back to with device code response, and\r\n     * polls token endpoint to exchange device code for tokens\r\n     * @param request\r\n     */\r\n    public async acquireToken(request: CommonDeviceCodeRequest): Promise<AuthenticationResult | null> {\r\n        const deviceCodeResponse: DeviceCodeResponse = await this.getDeviceCode(request);\r\n        request.deviceCodeCallback(deviceCodeResponse);\r\n        const reqTimestamp = TimeUtils.nowSeconds();\r\n        const response: ServerAuthorizationTokenResponse = await this.acquireTokenWithDeviceCode(\r\n            request,\r\n            deviceCodeResponse);\r\n\r\n        const responseHandler = new ResponseHandler(\r\n            this.config.authOptions.clientId,\r\n            this.cacheManager,\r\n            this.cryptoUtils,\r\n            this.logger,\r\n            this.config.serializableCache,\r\n            this.config.persistencePlugin\r\n        );\r\n\r\n        // Validate response. This function throws a server error if an error is returned by the server.\r\n        responseHandler.validateTokenResponse(response);\r\n        return await responseHandler.handleServerTokenResponse(\r\n            response,\r\n            this.authority,\r\n            reqTimestamp,\r\n            request\r\n        );\r\n    }\r\n\r\n    /**\r\n     * Creates device code request and executes http GET\r\n     * @param request\r\n     */\r\n    private async getDeviceCode(request: CommonDeviceCodeRequest): Promise<DeviceCodeResponse> {\r\n        const queryString = this.createQueryString(request);\r\n        const headers = this.createDefaultTokenRequestHeaders();\r\n        const thumbprint: RequestThumbprint = {\r\n            clientId: this.config.authOptions.clientId,\r\n            authority: request.authority,\r\n            scopes: request.scopes\r\n        };\r\n\r\n        return this.executePostRequestToDeviceCodeEndpoint(this.authority.deviceCodeEndpoint, queryString, headers, thumbprint);\r\n    }\r\n\r\n    /**\r\n     * Executes POST request to device code endpoint\r\n     * @param deviceCodeEndpoint\r\n     * @param queryString\r\n     * @param headers\r\n     */\r\n    private async executePostRequestToDeviceCodeEndpoint(\r\n        deviceCodeEndpoint: string,\r\n        queryString: string,\r\n        headers: Record<string, string>,\r\n        thumbprint: RequestThumbprint): Promise<DeviceCodeResponse> {\r\n\r\n        const {\r\n            body: {\r\n                user_code: userCode,\r\n                device_code: deviceCode,\r\n                verification_uri: verificationUri,\r\n                expires_in: expiresIn,\r\n                interval,\r\n                message\r\n            }\r\n        } = await this.networkManager.sendPostRequest<ServerDeviceCodeResponse>(\r\n            thumbprint,\r\n            deviceCodeEndpoint,\r\n            {\r\n                body: queryString,\r\n                headers: headers\r\n            });\r\n\r\n        return {\r\n            userCode,\r\n            deviceCode,\r\n            verificationUri,\r\n            expiresIn,\r\n            interval,\r\n            message\r\n        };\r\n    }\r\n\r\n    /**\r\n     * Create device code endpoint query parameters and returns string\r\n     */\r\n    private createQueryString(request: CommonDeviceCodeRequest): string {\r\n\r\n        const parameterBuilder: RequestParameterBuilder = new RequestParameterBuilder();\r\n\r\n        parameterBuilder.addScopes(request.scopes);\r\n        parameterBuilder.addClientId(this.config.authOptions.clientId);\r\n\r\n        if (!StringUtils.isEmpty(request.claims) || this.config.authOptions.clientCapabilities && this.config.authOptions.clientCapabilities.length > 0) {\r\n            parameterBuilder.addClaims(request.claims, this.config.authOptions.clientCapabilities);\r\n        }\r\n\r\n        return parameterBuilder.createQueryString();\r\n    }\r\n\r\n    /**\r\n     * Creates token request with device code response and polls token endpoint at interval set by the device code\r\n     * response\r\n     * @param request\r\n     * @param deviceCodeResponse\r\n     */\r\n    private async acquireTokenWithDeviceCode(\r\n        request: CommonDeviceCodeRequest,\r\n        deviceCodeResponse: DeviceCodeResponse): Promise<ServerAuthorizationTokenResponse> {\r\n\r\n        const requestBody = this.createTokenRequestBody(request, deviceCodeResponse);\r\n        const headers: Record<string, string> = this.createDefaultTokenRequestHeaders();\r\n\r\n        const userSpecifiedTimeout = request.timeout ? TimeUtils.nowSeconds() + request.timeout : undefined;\r\n        const deviceCodeExpirationTime = TimeUtils.nowSeconds() + deviceCodeResponse.expiresIn;\r\n        const pollingIntervalMilli = deviceCodeResponse.interval * 1000;\r\n\r\n        /*\r\n         * Poll token endpoint while (device code is not expired AND operation has not been cancelled by\r\n         * setting CancellationToken.cancel = true). POST request is sent at interval set by pollingIntervalMilli\r\n         */\r\n        return new Promise<ServerAuthorizationTokenResponse>((resolve, reject) => {\r\n\r\n            const intervalId: ReturnType<typeof setTimeout> = setInterval(async () => {\r\n                try {\r\n                    if (request.cancel) {\r\n\r\n                        this.logger.error(\"Token request cancelled by setting DeviceCodeRequest.cancel = true\");\r\n                        clearInterval(intervalId);\r\n                        reject(ClientAuthError.createDeviceCodeCancelledError());\r\n\r\n                    } else if (userSpecifiedTimeout && userSpecifiedTimeout < deviceCodeExpirationTime && TimeUtils.nowSeconds() > userSpecifiedTimeout) {\r\n\r\n                        this.logger.error(`User defined timeout for device code polling reached. The timeout was set for ${userSpecifiedTimeout}`);\r\n                        clearInterval(intervalId);\r\n                        reject(ClientAuthError.createUserTimeoutReachedError());\r\n\r\n                    } else if (TimeUtils.nowSeconds() > deviceCodeExpirationTime) {\r\n\r\n                        if (userSpecifiedTimeout) {\r\n                            this.logger.verbose(`User specified timeout ignored as the device code has expired before the timeout elapsed. The user specified timeout was set for ${userSpecifiedTimeout}`);\r\n                        }\r\n\r\n                        this.logger.error(`Device code expired. Expiration time of device code was ${deviceCodeExpirationTime}`);\r\n                        clearInterval(intervalId);\r\n                        reject(ClientAuthError.createDeviceCodeExpiredError());\r\n\r\n                    } else {\r\n                        const thumbprint: RequestThumbprint = {\r\n                            clientId: this.config.authOptions.clientId,\r\n                            authority: request.authority,\r\n                            scopes: request.scopes\r\n                        };\r\n                        const response = await this.executePostToTokenEndpoint(\r\n                            this.authority.tokenEndpoint,\r\n                            requestBody,\r\n                            headers,\r\n                            thumbprint);\r\n\r\n                        if (response.body && response.body.error === Constants.AUTHORIZATION_PENDING) {\r\n                            // user authorization is pending. Sleep for polling interval and try again\r\n                            this.logger.info(response.body.error_description || \"no_error_description\");\r\n                        } else {\r\n                            clearInterval(intervalId);\r\n                            resolve(response.body);\r\n                        }\r\n                    }\r\n                } catch (error) {\r\n                    clearInterval(intervalId);\r\n                    reject(error);\r\n                }\r\n            }, pollingIntervalMilli);\r\n        });\r\n    }\r\n\r\n    /**\r\n     * Creates query parameters and converts to string.\r\n     * @param request\r\n     * @param deviceCodeResponse\r\n     */\r\n    private createTokenRequestBody(request: CommonDeviceCodeRequest, deviceCodeResponse: DeviceCodeResponse): string {\r\n\r\n        const requestParameters: RequestParameterBuilder = new RequestParameterBuilder();\r\n\r\n        requestParameters.addScopes(request.scopes);\r\n        requestParameters.addClientId(this.config.authOptions.clientId);\r\n        requestParameters.addGrantType(GrantType.DEVICE_CODE_GRANT);\r\n        requestParameters.addDeviceCode(deviceCodeResponse.deviceCode);\r\n        const correlationId = request.correlationId || this.config.cryptoInterface.createNewGuid();\r\n        requestParameters.addCorrelationId(correlationId);\r\n        requestParameters.addClientInfo();\r\n        requestParameters.addLibraryInfo(this.config.libraryInfo);\r\n        requestParameters.addThrottling();\r\n        \r\n        if (this.serverTelemetryManager) {\r\n            requestParameters.addServerTelemetry(this.serverTelemetryManager);\r\n        }\r\n\r\n        if (!StringUtils.isEmptyObj(request.claims) || this.config.authOptions.clientCapabilities && this.config.authOptions.clientCapabilities.length > 0) {\r\n            requestParameters.addClaims(request.claims, this.config.authOptions.clientCapabilities);\r\n        }\r\n        return requestParameters.createQueryString();\r\n    }\r\n}\r\n"]},"metadata":{},"sourceType":"module"}